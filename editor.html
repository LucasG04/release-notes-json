<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Release Notes Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body class="bg-gray-50 min-h-screen" x-data="editorApp()">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <header class="mb-8">
        <!-- Configuration Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">Konfiguration</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Bitbucket Raw URL</label
              >
              <input
                type="text"
                x-model="bitbucketUrl"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="https://bitbucket.org/.../data.json"
              />
            </div>
            <button
              @click="loadReleaseNotes()"
              class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              Release Notes laden
            </button>
          </div>
        </div>
      </header>

      <!-- Bookmarks Section -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Bookmarks</h2>
        <div class="space-y-3">
          <template x-for="bookmark in bookmarks" :key="bookmark.url">
            <a
              :href="bookmark.url"
              target="_blank"
              rel="noopener noreferrer"
              class="flex items-start gap-3 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-blue-500 transition-colors"
            >
              <i
                data-lucide="external-link"
                class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"
              ></i>
              <div class="flex-1 min-w-0">
                <div
                  class="font-medium text-gray-900"
                  x-text="bookmark.name"
                ></div>
                <div
                  class="text-sm text-gray-600"
                  x-text="bookmark.description"
                ></div>
                <div
                  class="text-xs text-gray-400 truncate mt-1"
                  x-text="bookmark.url"
                ></div>
              </div>
            </a>
          </template>
        </div>
      </div>

      <!-- Toast Messages Container -->
      <div class="fixed top-4 right-4 z-50 space-y-2 max-w-md">
        <template x-for="message in messages" :key="message.id">
          <div
            x-show="message.visible"
            x-transition:enter="transform transition-all duration-300 ease-in-out"
            x-transition:enter-start="opacity-0 translate-x-full"
            x-transition:enter-end="opacity-100 translate-x-0"
            x-transition:leave="transform transition-all duration-300 ease-in-out"
            x-transition:leave-start="opacity-100 translate-x-0"
            x-transition:leave-end="opacity-0 translate-x-full"
            :class="{
              'bg-red-500 text-white': message.type === 'error',
              'bg-green-500 text-white': message.type === 'success',
              'bg-blue-500 text-white': message.type === 'info'
            }"
            class="px-6 py-4 rounded-lg shadow-lg"
          >
            <div class="flex items-center justify-between gap-4">
              <span class="font-medium" x-text="message.text"></span>
              <button
                @click="removeMessage(message.id)"
                class="text-white hover:text-gray-200 font-bold text-xl leading-none"
              >
                &times;
              </button>
            </div>
          </div>
        </template>
      </div>

      <!-- Add New Release Note -->
      <div class="mt-8">
        <button
          @click="addNewReleaseNote()"
          class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          + Neue Release Note hinzufügen
        </button>
      </div>

      <!-- Release Notes List -->
      <div class="mt-8 space-y-4">
        <template x-for="rn in sortedReleaseNotes" :key="rn._id">
          <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b border-gray-200">
              <div class="flex justify-between items-center">
                <div class="flex-1">
                  <h3 class="text-lg font-semibold">
                    <span x-text="rn.version || 'Neue Version'"></span>
                    <span
                      x-show="!rn.version"
                      class="text-gray-400 text-sm ml-2"
                      >(noch nicht gespeichert)</span
                    >
                  </h3>
                  <p class="text-sm text-gray-600">
                    Datum: <span x-text="formatDate(rn.date)"></span>
                  </p>
                </div>
                <div class="flex gap-2">
                  <button
                    @click="rn.expanded = !rn.expanded"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm"
                  >
                    <span
                      x-text="rn.expanded ? 'Schließen' : 'Bearbeiten'"
                    ></span>
                  </button>
                  <button
                    @click="deleteReleaseNote(rn._id)"
                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 text-sm"
                  >
                    Löschen
                  </button>
                </div>
              </div>
            </div>
            <div x-show="rn.expanded" x-transition class="p-6">
              <!-- Version -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Version *</label
                >
                <input
                  type="text"
                  x-model="rn.version"
                  pattern="^[0-9]+\.[0-9]+\.[0-9]+$"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                  placeholder="1.0.0"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Format: X.Y.Z (z.B. 1.2.3)
                </p>
              </div>

              <!-- Date -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Datum *</label
                >
                <input
                  type="date"
                  x-model="rn.date"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <!-- Changes -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Änderungen *</label
                >
                <div class="space-y-4">
                  <template
                    x-for="(change, changeIndex) in rn.changes"
                    :key="changeIndex"
                  >
                    <div
                      class="border border-gray-300 rounded-lg p-4 bg-gray-50"
                    >
                      <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-sm">
                          Änderung <span x-text="changeIndex + 1"></span>
                        </h4>
                        <button
                          @click="removeChange(rn, changeIndex)"
                          class="text-red-600 hover:text-red-800 text-sm"
                        >
                          Entfernen
                        </button>
                      </div>

                      <!-- Title -->
                      <div class="mb-3">
                        <label
                          class="block text-sm font-medium text-gray-700 mb-1"
                          >Title *</label
                        >
                        <div class="flex gap-2">
                          <input
                            type="text"
                            x-model="change.title"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                            placeholder="Titel der Änderung"
                          />
                          <select
                            x-model="change.type"
                            class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                          >
                            <template x-for="type in changeTypes" :key="type">
                              <option :value="type" x-text="type"></option>
                            </template>
                          </select>
                        </div>
                      </div>

                      <!-- Audience -->
                      <div class="mb-3">
                        <label
                          class="block text-sm font-medium text-gray-700 mb-1"
                          >Zielgruppe *</label
                        >
                        <div class="flex flex-wrap items-center gap-4">
                          <template
                            x-for="aud in availableAudiences"
                            :key="aud"
                          >
                            <label class="flex items-center">
                              <input
                                type="checkbox"
                                :checked="change.audience.includes(aud)"
                                @change="toggleAudience(change, aud)"
                                class="mr-2"
                              />
                              <span x-text="aud"></span>
                            </label>
                          </template>
                        </div>
                      </div>

                      <!-- Description -->
                      <div class="mb-3">
                        <label
                          class="block text-sm font-medium text-gray-700 mb-1"
                          >Beschreibung *</label
                        >
                        <textarea
                          x-model="change.description"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                          rows="3"
                        ></textarea>
                      </div>

                      <!-- Image URLs -->
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-700 mb-1"
                          >Bild-URLs (optional)</label
                        >
                        <div class="space-y-2">
                          <template
                            x-for="(url, urlIndex) in change.imageUrls"
                            :key="urlIndex"
                          >
                            <div class="flex gap-2">
                              <input
                                type="url"
                                x-model="change.imageUrls[urlIndex]"
                                pattern="^https://[^\s/$.?#].[^\s]*$"
                                class="flex-1 px-3 py-1 border border-gray-300 rounded-md text-sm"
                                placeholder="https://example.com/image.png"
                              />
                              <button
                                @click="openImagePreview(url)"
                                class="text-blue-600 hover:text-blue-800 px-2 text-sm"
                                title="Vorschau"
                              >
                                &#x1F441;
                              </button>
                              <button
                                @click="removeImageUrl(change, urlIndex)"
                                class="text-red-600 hover:text-red-800 px-2 text-sm"
                              >
                                ✕
                              </button>
                            </div>
                          </template>
                        </div>
                        <button
                          @click="addImageUrl(change)"
                          class="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm"
                        >
                          + Bild-URL hinzufügen
                        </button>
                      </div>
                    </div>
                  </template>
                </div>
                <button
                  @click="addChange(rn)"
                  class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm"
                >
                  + Änderung hinzufügen
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- Generate JSON Section -->
      <div class="mt-8 bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">JSON Ausgabe</h2>
          <div class="flex items-center gap-2">
            <button
              @click="generateJSON()"
              class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
            >
              JSON generieren
            </button>
            <button
              @click="generateJSON(); copyToClipboard()"
              class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              Copy JSON to Clipboard
            </button>
          </div>
        </div>
        <div>
          <pre
            x-text="jsonOutput"
            class="bg-gray-100 p-4 rounded-md overflow-x-auto text-sm"
          ></pre>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div
      x-show="imagePreviewOpen"
      @click="closeImagePreview()"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
      @keydown.escape.window="closeImagePreview()"
    >
      <div class="relative max-w-7xl max-h-full">
        <button
          @click="closeImagePreview()"
          class="absolute -top-10 right-0 text-white hover:text-gray-300 text-3xl font-bold leading-none"
        >
          &times;
        </button>
        <img
          :src="previewImageUrl"
          alt="Vorschau"
          class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl"
          @click.stop
        />
      </div>
    </div>

    <script>
      // Alpine.js Component
      function editorApp() {
        return {
          // Constants
          DEFAULT_BITBUCKET_URL: "",
          availableAudiences: ["ADMIN", "USER", "DEVOPS"],
          changeTypes: ["feature", "change", "fix"],
          bookmarks: [
            {
              name: "Bitbucket Repository",
              url: "https://bitbucket.org/your-repo",
              description: "Haupt-Repository",
            },
            {
              name: "Dokumentation",
              url: "https://docs.example.com",
              description: "Projekt-Dokumentation",
            },
            {
              name: "Issue Tracker",
              url: "https://jira.example.com",
              description: "Bug- und Feature-Tracking",
            },
          ],

          // State
          bitbucketUrl: "",
          releaseNotes: [],
          nextId: 0,
          messages: [],
          messageIdCounter: 0,
          jsonOutput: "",
          imagePreviewOpen: false,
          previewImageUrl: "",

          // Initialization
          init() {
            this.bitbucketUrl =
              localStorage.getItem("lastUsedJsonUrl") ||
              this.DEFAULT_BITBUCKET_URL;

            // Initialize Lucide icons after Alpine renders
            this.$nextTick(() => {
              lucide.createIcons();
            });
          },

          // Computed property for sorted release notes
          get sortedReleaseNotes() {
            return [...this.releaseNotes].sort((a, b) => {
              if (a.version === "") return -1;
              if (b.version === "") return 1;

              const versionA = (a.version || "0.0.0").split(".").map(Number);
              const versionB = (b.version || "0.0.0").split(".").map(Number);

              for (let i = 0; i < 3; i++) {
                if (versionB[i] !== versionA[i]) {
                  return versionB[i] - versionA[i];
                }
              }
              return 0;
            });
          },

          // Toast Messages
          showMessage(text, type = "info") {
            const id = this.messageIdCounter++;
            const message = { id, text, type, visible: true };
            this.messages.push(message);

            setTimeout(() => {
              this.removeMessage(id);
            }, 5000);
          },

          removeMessage(id) {
            const index = this.messages.findIndex((m) => m.id === id);
            if (index !== -1) {
              this.messages[index].visible = false;
              setTimeout(() => {
                this.messages = this.messages.filter((m) => m.id !== id);
              }, 300);
            }
          },

          // Load Release Notes
          async loadReleaseNotes() {
            if (!this.bitbucketUrl.trim()) {
              this.showMessage("Bitte geben Sie eine URL ein.", "error");
              return;
            }

            try {
              const response = await fetch(this.bitbucketUrl);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              const data = await response.json();

              if (!Array.isArray(data)) {
                throw new Error("JSON muss ein Array sein.");
              }

              this.releaseNotes = data.map((rn) => ({
                ...rn,
                _id: this.nextId++,
                expanded: false,
                changes: (rn.changes || []).map((change) => ({
                  ...change,
                  imageUrls: change.imageUrls || [],
                })),
              }));

              localStorage.setItem("lastUsedJsonUrl", this.bitbucketUrl);

              this.showMessage(
                `${this.releaseNotes.length} Release Notes erfolgreich geladen.`,
                "success"
              );

              this.$nextTick(() => {
                lucide.createIcons();
              });
            } catch (error) {
              this.showMessage(`Fehler beim Laden: ${error.message}`, "error");
            }
          },

          // Add new release note
          addNewReleaseNote() {
            const newReleaseNote = {
              _id: this.nextId++,
              version: "",
              date: new Date().toISOString().split("T")[0],
              changes: [],
              expanded: true,
            };
            this.releaseNotes.unshift(newReleaseNote);
          },

          // Save release note
          saveReleaseNote(rn) {
            // Validation
            if (!rn.version || !/^[0-9]+\.[0-9]+\.[0-9]+$/.test(rn.version)) {
              this.showMessage("Ungültige Version (Format: X.Y.Z)", "error");
              return;
            }
            if (!rn.date || !/^\d{4}-\d{2}-\d{2}$/.test(rn.date)) {
              this.showMessage(
                "Ungültiges Datum (Format: YYYY-MM-DD)",
                "error"
              );
              return;
            }

            // Validate changes
            for (let i = 0; i < rn.changes.length; i++) {
              const change = rn.changes[i];

              if (!change.title || change.title.trim().length < 1) {
                this.showMessage(
                  `Change ${i + 1}: Titel ist erforderlich`,
                  "error"
                );
                return;
              }

              if (!change.audience || change.audience.length === 0) {
                this.showMessage(
                  `Change ${i + 1}: Mindestens eine Zielgruppe erforderlich`,
                  "error"
                );
                return;
              }

              if (!change.description || change.description.trim().length < 1) {
                this.showMessage(
                  `Change ${i + 1}: Beschreibung fehlt`,
                  "error"
                );
                return;
              }

              // Validate image URLs
              if (change.imageUrls) {
                for (let j = 0; j < change.imageUrls.length; j++) {
                  const url = change.imageUrls[j];
                  if (url && !/^https:\/\/[^\s/$.?#].[^\s]*$/.test(url)) {
                    this.showMessage(
                      `Change ${i + 1}, URL ${j + 1}: Ungültige URL`,
                      "error"
                    );
                    return;
                  }
                }
              }
            }

            if (rn.changes.length === 0) {
              this.showMessage(
                "Mindestens eine Änderung erforderlich",
                "error"
              );
              return;
            }

            this.showMessage(
              "Release Note erfolgreich gespeichert!",
              "success"
            );
            rn.expanded = false;
          },

          // Delete release note
          deleteReleaseNote(id) {
            if (confirm("Möchten Sie diese Release Note wirklich löschen?")) {
              this.releaseNotes = this.releaseNotes.filter(
                (rn) => rn._id !== id
              );
              this.showMessage("Release Note gelöscht.", "success");
            }
          },

          // Add change to release note
          addChange(rn) {
            if (!rn.changes) rn.changes = [];

            rn.changes.push({
              title: "",
              type: "feature",
              audience: [...this.availableAudiences],
              description: "",
              imageUrls: [],
            });
          },

          // Remove change from release note
          removeChange(rn, changeIndex) {
            rn.changes.splice(changeIndex, 1);
          },

          // Toggle audience for a change
          toggleAudience(change, audience) {
            const index = change.audience.indexOf(audience);
            if (index > -1) {
              change.audience.splice(index, 1);
            } else {
              change.audience.push(audience);
            }
          },

          // Add image URL to change
          addImageUrl(change) {
            if (!change.imageUrls) change.imageUrls = [];
            change.imageUrls.push("");
          },

          // Remove image URL from change
          removeImageUrl(change, urlIndex) {
            change.imageUrls.splice(urlIndex, 1);
          },

          // Generate JSON
          generateJSON() {
            const errors = [];
            const result = [];

            for (const rn of this.releaseNotes) {
              if (!rn.version || !/^[0-9]+\.[0-9]+\.[0-9]+$/.test(rn.version)) {
                errors.push(
                  `Release Note ID ${rn._id}: Ungültige Version (Format: X.Y.Z)`
                );
                continue;
              }

              if (!rn.date || !/^\d{4}-\d{2}-\d{2}$/.test(rn.date)) {
                errors.push(
                  `Release Note ID ${rn._id}: Ungültiges Datum (Format: YYYY-MM-DD)`
                );
                continue;
              }

              const changes = [];
              for (let i = 0; i < rn.changes.length; i++) {
                const change = rn.changes[i];

                if (!change.title || change.title.trim().length < 1) {
                  errors.push(
                    `Release Note ${rn.version}, Change ${
                      i + 1
                    }: Titel ist erforderlich`
                  );
                  continue;
                }

                if (!change.audience || change.audience.length === 0) {
                  errors.push(
                    `Release Note ${rn.version}, Change ${
                      i + 1
                    }: Mindestens eine Zielgruppe erforderlich`
                  );
                  continue;
                }

                if (
                  !change.description ||
                  change.description.trim().length < 1
                ) {
                  errors.push(
                    `Release Note ${rn.version}, Change ${
                      i + 1
                    }: Beschreibung fehlt`
                  );
                  continue;
                }

                const validImageUrls = (change.imageUrls || []).filter(
                  (url) => {
                    if (!url.trim()) return false;
                    if (!/^https:\/\/[^\s/$.?#].[^\s]*$/.test(url)) {
                      errors.push(
                        `Release Note ${rn.version}, Change ${
                          i + 1
                        }: Ungültige URL "${url}"`
                      );
                      return false;
                    }
                    return true;
                  }
                );

                const changeData = {
                  title: change.title,
                  type: change.type,
                  audience: change.audience,
                  description: change.description,
                };

                if (validImageUrls.length > 0) {
                  changeData.imageUrls = validImageUrls;
                }

                changes.push(changeData);
              }

              if (changes.length === 0) {
                errors.push(
                  `Release Note ${rn.version}: Mindestens eine Änderung erforderlich`
                );
                continue;
              }

              result.push({
                version: rn.version,
                date: rn.date,
                changes,
              });
            }

            if (errors.length > 0) {
              this.showMessage(
                `Validierungsfehler:\n${errors.join("\n")}`,
                "error"
              );
              return;
            }

            this.jsonOutput = JSON.stringify(result, null, 2);
          },

          // Copy to clipboard
          copyToClipboard() {
            if (!this.jsonOutput) {
              this.showMessage("Bitte generieren Sie zuerst JSON.", "error");
              return;
            }

            navigator.clipboard
              .writeText(this.jsonOutput)
              .then(() => {
                this.showMessage(
                  "JSON in die Zwischenablage kopiert!",
                  "success"
                );
              })
              .catch((err) => {
                this.showMessage(
                  `Fehler beim Kopieren: ${err.message}`,
                  "error"
                );
              });
          },

          // Image preview
          openImagePreview(url) {
            if (!url || !url.trim()) {
              this.showMessage("Bitte geben Sie zuerst eine URL ein.", "error");
              return;
            }
            this.previewImageUrl = url;
            this.imagePreviewOpen = true;
          },

          closeImagePreview() {
            this.imagePreviewOpen = false;
            this.previewImageUrl = "";
          },

          // Utility: Format date
          formatDate(dateString) {
            const date = new Date(dateString);
            return isNaN(date.getTime())
              ? "N/A"
              : date.toLocaleDateString("de-DE", {
                  year: "numeric",
                  month: "2-digit",
                  day: "2-digit",
                });
          },
        };
      }

      // Initialize Lucide icons when DOM is ready
      document.addEventListener("alpine:init", () => {
        lucide.createIcons();
      });
    </script>
  </body>
</html>
